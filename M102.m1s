OldTool = GetCurrentTool()			NewTool = GetSelectedTool()			'Tool given by the T Code (M6 T...)If OldTool=NewTool Then	Response=MachMsg("Old Tool = New Tool", "WARNING!", 1)		'if the new tool is the old tooly no tool change is needed	If Response = 2 Then		Message ("Stopping")		DoOEMButton(1003)						'Stop Button	End If	EndEnd IfDoSpinStop()                 	 ' Make sure the spindle is OFFCode"M09"                    	 ' Make sure the coolant is OFFIf OldTool=0 Then	Response=MachMsg("Tool 0 Error (Set current tool to tool in spindle) Program is stopped", "WARNING!", 0)		'if the new tool is the old tooly no tool change is needed	DoOEMButton(1003)							'Stop Button	EndEnd If'Postitions of SlotsSlot1X=GetUserDro(2051)Slot1Y=GetUserDro(2052)Slot1Z=GetUserDro(2053)Slot2X=GetUserDro(2054)Slot2Y=GetUserDro(2055)Slot2Z=GetUserDro(2056)Slot3X=GetUserDro(2057)Slot3Y=GetUserDro(2058)Slot3Z=GetUserDro(2059)Slot4X=GetUserDro(2060)Slot4Y=GetUserDro(2061)Slot4Z=GetUserDro(2062)Slot5X=GetUserDro(2063)Slot5Y=GetUserDro(2064)Slot5Z=GetUserDro(2065)Slot6X=GetUserDro(2066)Slot6Y=GetUserDro(2067)Slot6Z=GetUserDro(2068)Slot7X=GetUserDro(2069)Slot7Y=GetUserDro(2070)Slot7Z=GetUserDro(2071)Slot8X=GetUserDro(2072)Slot8Y=GetUserDro(2073)Slot8Z=GetUserDro(2074)Slot9X=GetUserDro(2075)Slot9Y=GetUserDro(2076)Slot9Z=GetUserDro(2077)Slot10X=GetUserDro(2078)Slot10Y=GetUserDro(2079)Slot10Z=GetUserDro(2080)'Variables for movementHorizDistFromSlot=GetUserDro(2120)SafeHight=GetUserDro(2121)TraverseHeight=GetUserDro(2122)PutHolderInRackSpeed=GetUserDro(2123)TraverseSpeed=GetUserDro(2124)MoveDownSpeed=GetUserDro(2125)TakeHolderFromRackSpeed=GetUserDro(2126)'get the tools that are stored in the ATCToolInSlot1=GetUserDro(2001)ToolInSlot2=GetUserDro(2002)ToolInSlot3=GetUserDro(2003)ToolInSlot4=GetUserDro(2004)ToolInSlot5=GetUserDro(2005)ToolInSlot6=GetUserDro(2006)ToolInSlot7=GetUserDro(2007)ToolInSlot8=GetUserDro(2008)ToolInSlot9=GetUserDro(2009)ToolInSlot10=GetUserDro(2010)'if one slot has the tool 0 in it this could cause a problem, as the current tool when Mach is started is T0If ToolInSlot1=0 Or ToolInSlot2=0 Or ToolInSlot3=0 Or ToolInSlot3=0 Or ToolInSlot4=0 Or ToolInSlot5=0 Or ToolInSlot6=0 Or ToolInSlot7=0 Or ToolInSlot8=0 Or ToolInSlot9=0 Or ToolInSlot10=0 Then 	DoButton(21)	Response = MachMsg("Tool 0 not allowed in the tooltable, if rack space is Empty give it a unused toolnumber (253)", "WARNING!", 0)	End	End If'Tool Setter VariablesRemeassureOffset1=GetUserLED(2003)ToolBreakDetection1=GetUserLED(2004)NewToolProbing1=GetUserLED(2005)RemeassureOffset2=GetUserLED(2006)ToolBreakDetection2=GetUserLED(2007)NewToolProbing2=GetUserLED(2008)RemeassureOffset3=GetUserLED(2009)ToolBreakDetection3=GetUserLED(2010)NewToolProbing3=GetUserLED(2011)RemeassureOffset4=GetUserLED(2012)ToolBreakDetection4=GetUserLED(2013)NewToolProbing4=GetUserLED(2014)RemeassureOffset5=GetUserLED(2015)ToolBreakDetection5=GetUserLED(2016)NewToolProbing5=GetUserLED(2017)RemeassureOffset6=GetUserLED(2018)ToolBreakDetection6=GetUserLED(2019)NewToolProbing6=GetUserLED(2020)RemeassureOffset7=GetUserLED(2021)ToolBreakDetection7=GetUserLED(2022)NewToolProbing7=GetUserLED(2023)RemeassureOffset8=GetUserLED(2024)ToolBreakDetection8=GetUserLED(2025)NewToolProbing8=GetUserLED(2026)RemeassureOffset9=GetUserLED(2027)ToolBreakDetection9=GetUserLED(2028)NewToolProbing9=GetUserLED(2029)RemeassureOffset10=GetUserLED(2030)ToolBreakDetection10=GetUserLED(2031)NewToolProbing10=GetUserLED(2032)RapidDownHeight=GetUserDro(2150)FastProbingSpeed=GetUserDro(2151)SlowProbingSpeed=GetUserDro(2152)RetractDistance=GetUserDro(2153)LowestHeight=GetUserDro(2154)CloseDistance=GetUserDro(2155)ToolSetterPositionX=GetUserDro(2156)ToolSetterPositionY=GetUserDro(2157)'Other VariablesToolInSpindle=GetUserLED(2000)  			'Is There a Tool in the spindle ? ToolBreakTriggerLength=GetUserDro(2158)OldLengthOffset=GetDro(23)				'Saving the old Length Offset for the Tool break detection and for faster Movement'Response = MachMsg("Height = "& CloseDistance - OldLengthOffset, "WARNING!", 0)If Toolinspindle=1 Then						Message("bring back old tool")	Message("tool in spindle")	Call SlotPos(OldTool)							'get the right slot for the old tool	code "G53 G0 Z" & SafeHight						'move to max Z	While IsMoving()		sleep(100)		Wend	If ToolBreakDetection=1 Then		ProbingType="TBD"			Call Toolsetting(ProbingType,Slot,OldLengthOffset)		NewLengthOffset=GetDro(23)		'If OldLengthOffset-NewLengthOffset >= ToolBreakTriggerLength Or OldLengthOffset-NewLengthOffset <= -ToolBreakTriggerLength Then		'	DoButton(21)		'	Response = MachMsg("tool seems to be broken, E-Stop triggered to safe following tools", "WARNING!", 0)		'	Message("tool break stop triggered for tool" & OldTool)		'	End		'	End If		End If	code "G53 G0 X" & SlotX & " Y" & SlotY+HorizDistFromSlot			'move next to selected slot , ready to slide in the tool	While IsMoving()		sleep(100)		Wend	code "G53 G0 Z" & SlotZ								While IsMoving()		sleep(100)		Wend	Code "G53 G1 F" &PutHolderInRackSpeed & " X" & SlotX & " Y"& SlotY		'slide in the tool	While IsMoving()		sleep(100)		Wend	ActivateSignal(OUTPUT1)							'activate the drawbar to loosen the tool	Sleep(200)								'wait a bit (for solenopid and pneumatic system)	SetUserLED(2000,0) 	SetCurrentTool(99)	Code "G53 G0 Z" & TraverseHeight						'move up to the traverse height	While IsMoving()		sleep(100)		Wend	Call SlotPos(NewTool)	 						'get the right slot for the new Tool 	Code "G53 G1 F" & TraverseSpeed & " X" & SlotX & " Y"& SlotY			'move above slot for new tool	While IsMoving()		sleep(100)		Wend	Code "G53 G1 F" & MoveDownSpeed & " Z" & SlotZ				'move down to grab new tool	While IsMoving()		sleep(100)		Wend	DeActivateSignal(Output1)						'grab the tool 	Sleep (200)								'wait a bit (for solenopid and pneumatic system)	SetUserLED(2000,1)	SetCurrentTool( NewTool )	code "G53 G1 F" & TakeHolderFromRackSpeed & " X" & SlotX & " Y"& SlotY+HorizDistFromSlot	While IsMoving()		sleep(100)		Wend	code "G53 G0 Z" & SafeHight	While IsMoving()		sleep(100)		Wend	If NewToolProbing=1 Then		ProbingType="NTP"		Call Toolsetting(ProbingType,Slot,OldLengthOffset)	ElseIf RemeassureOffset=1 Then		ProbingType="Rm"			Call Toolsetting(ProbingType, Slot,OldLengthOffset)	End If	Else 	Message("no tool in spindle")	SetCurrentTool(0)	Call SlotPos(NewTool)			 				'get the right slot for the new Tool 	Code "G53 G0 Z" & SafeHight						'move up to the safe height	While IsMoving()		sleep(100)		Wend	Code "G53 G0 X" & SlotX & " Y"& SlotY					'move above slot for new tool	While IsMoving()		sleep(100)		Wend	ActivateSignal(OUTPUT1)							'activate the drawbar	Sleep (200)						Code "G53 G1 F" & MoveDownSpeed & " Z" & SlotZ				'move down to grab new tool	While IsMoving()		sleep(100)		Wend	DeActivateSignal(Output1)						'grab the tool 	Sleep (200)								'wait a bit (for solenopid and pneumatic system)	SetUserLED(2000,1)	SetCurrentTool( NewTool )	code "G53 G1 F" & TakeHolderFromRackSpeed & " X" & SlotX & " Y"& SlotY + HorizDistFromSlot	While IsMoving()		sleep(100)		Wend	code "G53 G0 Z" & SafeHight	While IsMoving()		sleep(100)		Wend	CurrentToolLength=GetDro(836)	If NewToolProbing=1 Then		ProbingType="NTP"		Call Toolsetting(ProbingType,Slot,OldLengthOffset)	ElseIf RemeassureOffset=1 Then		ProbingType="Rm"				Call Toolsetting(ProbingType, Slot,OldLengthOffset)	End IfEnd If    'Response = MachMsg("Toolchange done","Info", 0)'subprogram to decide which slot to move toSub SlotPos(ByVal ToolNumber As Integer)If ToolInSlot1=ToolNumber Then	Slot=1	SlotX=Slot1X	SlotY=Slot1Y	SlotZ=Slot1Z	RemeassureOffset=RemeassureOffset1	ToolBreakDetection=ToolBreakDetection1	NewToolProbing=NewToolProbing1	ElseIf ToolInSlot2=ToolNumber Then	Slot = 2	SlotX=Slot2X	SlotY=Slot2Y	SlotZ=Slot2Z	RemeassureOffset=RemeassureOffset2	ToolBreakDetection=ToolBreakDetection2	NewToolProbing=NewToolProbing2ElseIf ToolInSlot3=ToolNumber Then	Slot = 3	SlotX=Slot3X	SlotY=Slot3Y	SlotZ=Slot3Z	RemeassureOffset=RemeassureOffset3	ToolBreakDetection=ToolBreakDetection3	NewToolProbing=NewToolProbing3ElseIf ToolInSlot4=ToolNumber Then	Slot = 4	SlotX=Slot4X	SlotY=Slot4Y	SlotZ=Slot4Z	RemeassureOffset=RemeassureOffset4	ToolBreakDetection=ToolBreakDetection4	NewToolProbing=NewToolProbing4ElseIf ToolInSlot5=ToolNumber Then	Slot = 5	SlotX=Slot5X	SlotY=Slot5Y	SlotZ=Slot5Z	RemeassureOffset=RemeassureOffset5	ToolBreakDetection=ToolBreakDetection5	NewToolProbing=NewToolProbing5ElseIf ToolInSlot6=ToolNumber Then	Slot = 6	SlotX=Slot6X	SlotY=Slot6Y	SlotZ=Slot6Z	RemeassureOffset=RemeassureOffset6	ToolBreakDetection=ToolBreakDetection6	NewToolProbing=NewToolProbing6ElseIf ToolInSlot7=ToolNumber Then	Slot = 7	SlotX=Slot7X	SlotY=Slot7Y	SlotZ=Slot7Z	RemeassureOffset=RemeassureOffset7	ToolBreakDetection=ToolBreakDetection2	NewToolProbing=NewToolProbing7ElseIf ToolInSlot8=ToolNumber Then	Slot = 8	SlotX=Slot8X	SlotY=Slot8Y	SlotZ=Slot8Z	RemeassureOffset=RemeassureOffset8	ToolBreakDetection=ToolBreakDetection8	NewToolProbing=NewToolProbing8ElseIf ToolInSlot9=ToolNumber Then	Slot = 9	SlotX=Slot9X	SlotY=Slot9Y	SlotZ=Slot9Z	RemeassureOffset=RemeassureOffset9	ToolBreakDetection=ToolBreakDetection9	NewToolProbing=NewToolProbing9ElseIf ToolInSlot10=ToolNumber Then	Slot = 10	SlotX=Slot10X	SlotY=Slot10Y	SlotZ=Slot10Z	RemeassureOffset=RemeassureOffset10	ToolBreakDetection=ToolBreakDetection10	NewToolProbing=NewToolProbing10Else 	Response = MachMsg("No Slot for  this tool found in the Rack", "WARNING!", 0)	EndEnd IfSetUserDro(2101,SlotX)SetUserDro(2102,SlotY)SetUserDro(2103,SlotZ)message("Slot "& Slot)End Sub             Sub Toolsetting(ByVal ProbingType, Slot,OldLengthOffset)Code "G53 G0 Z" & SafeHight						'not really nescessary as we should allready be up , but safe is safeWhile IsMoving()	sleep(100)	Wendcode "G53 G0 X" & ToolSetterPositionX & " Y" & ToolSetterPositionY	'Move to ToolSetter PositionWhile IsMoving()	sleep(100)	Wend	If ProbingType="TBD" Or ProbingType = "Rm" Then						'if only a tool break detection or a remeassurement is needed we can safe time if we move down a bit before	'Response = MachMsg("Short probe cycle for faster program", "Info!", 0)	code "G53 G0 Z" & CloseDistance - OldLengthOffset 	'Response = MachMsg("Height = "& CloseDistance - OldLengthOffset, "WARNING!", 0)	While IsMoving()		sleep(100)		WendElse 	'Response = MachMsg("full probe cycle", "Info!", 0)	Code "G53 G0 Z" & RapidDownHeight	While IsMoving()		sleep(100)		WendEnd If'code "G53 G1 Z"'#########################################   actual Probing Cycle See mach 3 in werkstatt ##################################Code "G53 G0 Z" & SafeHightWhile IsMoving()	sleep(100)	WendMessage ("Probing done")If ProbingType = "NTP" Then	UserLEDNumber = Slot*3+2002	SetUserLED(UserLEDNumber,0)	End If	End Sub            